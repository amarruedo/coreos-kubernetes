#!/bin/bash

function define_proxy(){
	
	#creamos el servicio
    local TEMPLATE=/etc/systemd/system/haproxy.service
      [ -f $TEMPLATE ] || {
          echo "TEMPLATE: $TEMPLATE"
          mkdir -p $(dirname $TEMPLATE)
          cat << EOF > $TEMPLATE
[Unit]
Description=Haproxy service
After=docker.service
Requires=docker.service
[Service]
TimeoutStartSec=0
ExecStartPre=-/usr/bin/docker kill haproxy
ExecStartPre=-/usr/bin/docker rm haproxy
ExecStartPre=/usr/bin/docker pull haproxy:1.6
ExecStart=/usr/bin/bash -c \
"/usr/bin/docker run -d --name haproxy \
<% @ports.each do |port| -%>
<%= "-p #{port}:#{port}" -%> \
<% end -%>
-p 1936:1936 \
-v /dev/log:/dev/log \
-v /run/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro \
haproxy:1.6"

[Install]
WantedBy=multi-user.target
EOF
    }
}

define_proxy

systemctl stop update-engine; systemctl mask update-engine

systemctl daemon-reload

systemctl enable haproxy.service; systemctl start haproxy.service